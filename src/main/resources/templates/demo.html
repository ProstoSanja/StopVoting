<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/hwcrypto.js"></script>
    <script src="js/hwcrypto-legacy.js"></script>
    <script src="js/hex2base.js"></script>
</head>
<body>
    <button id="send">Send</button>
    <br/>
    <br/>
    <br/>
    <button id="get">get</button>
    <script>

        var queueFunc = null;

        function responseHandler(ev1) {
            var response = JSON.parse(ev1.target.response);
            switch (response.action) {
                case "request_signature":
                    endsign(response.payload);
                    break;
                case "error":
                    alert(response.payload);
                    break;
                case "auth_success":
                    alert(response.payload);
                    //enable sign/remove button
                    break;
                case "sign_success":
                    alert(response.payload);
                    //enable download button
                    break;
            }
            if (queueFunc != null) {
                var func = queueFunc;
                queueFunc = null;
                func();
            }
        }

        function getcertificate(func) {
            queueFunc = func;
            window.hwcrypto.getCertificate({lang: 'en'}).then(function(certificate) {
                window.certificate = certificate;
                var xhr = new XMLHttpRequest;
                xhr.onload = responseHandler;
                xhr.open("POST", "/auth", false);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.send("cert=" + window.certificate.hex);
            });
        }

        function startsign() {
            if  (window.certificate === undefined) {
                getcertificate(startsign);
            } else {
                var xhr = new XMLHttpRequest;
                xhr.onload = responseHandler;
                xhr.open("POST", "/sign/start", false);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.send("cert=" + window.certificate.hex);
            }
        }

        function endsign(data) {
            window.hwcrypto.sign(window.certificate, {type: 'SHA-256', hex: data}, {lang: 'en'}).then(function(signature) {
                var xhr = new XMLHttpRequest;
                xhr.onload = responseHandler;
                xhr.open("POST", "/sign/finish", false);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.send("signature="+signature.hex);
            });
        }

        function loadfile() {
            if  (window.certificate === undefined) {
                getcertificate(loadfile);
            } else {
                window.open("/get", "_blank");
            }
        }


        document.getElementById("send").onclick = startsign;
        document.getElementById("get").onclick = loadfile;
    </script>
</body>
</html>